#!/bin/bash

#
# vaultdump - A utility for dumping Vault creds relevant to a deployment
# USAGE: vaultdump *.yml
#
# author:  James Hunt <james@niftylogic.com>
# created: 2016-01-21
#

if [[ -z ${1} ]]; then
	echo >&2 "USAGE: $0 *.yml"
	exit 1
fi

need_command() {
	local cmd=${1:?need_command() - no command name given}

	if [[ ! -x "$(command -v $cmd)" ]]; then
		echo >&2 "${cmd} is not installed."
		exit 2
	fi
}

need_command vault

if [[ -z ${VAULT_ADDR} ]]; then
	echo >&2 "No \$VAULT_ADDR is set; are you targetting a Vault?"
	exit 1
fi

for path in $(grep -r '(( *vault ' "$@" | sed -e 's/.* (( *vault  *"//;s/:.*" *))//' | sort -u); do
	echo ${path}
	echo ${path} | sed -e 's/./-/g'
	vault read ${path} | sed -e '1,2d;s/^/  - /;s/      //'
	echo ; echo
done

# vim:ft=bash
