#!/bin/bash

#
# vaultdump - A utility for dumping Vault creds relevant to a deployment
# USAGE: vaultdump *.yml
#
# author:  James Hunt <james@niftylogic.com>
# created: 2016-01-21
#


need_command() {
	local cmd=${1:?need_command() - no command name given}

	if [[ ! -x "$(command -v $cmd)" ]]; then
		echo >&2 "${cmd} is not installed."
		exit 2
	fi
}

dump_secrets() {
	need_command vault
	for path in $(grep -r '(( *vault ' "$@" | sed -e 's/.* (( *vault  *"//;s/:.*" *))//' | sort -u); do
		echo "# ${path}"
		if [[ -n ${VAULT_ADDR} ]]; then
			vault read --format json ${path} | jq .data
			echo ; echo
		fi
	done
}

if [[ -n ${1} ]]; then
	dump_secrets "$@"
else
	dump_secrets $(find . -name '*.yml')
fi

# vim:ft=bash
