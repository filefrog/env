#!/usr/bin/perl

use strict;
use warnings;

my $screen = `which screen`;
chomp $screen;
if (! -x $screen) {
	print "screen binary not found;  is screen installed?\n";
	exit;
}

if ($ARGV[0] && $ARGV[0] eq '-h') {
    print <<'EOS';
Usage: s [id|name]
id is session number, not pid. Run s without args to see session id.
Name is session name
EOS
    exit;
}

my @sessions;
my $i = 1;

my @buffer = `screen -ls 2>/dev/null`;

if ($buffer[0] =~ m/No Sockets found/) {
    # no screens?  start a new one!
    `screen`; exit $?;
}

print <<'EOS';

  CURRENT SESSIONS
  ------------------------
EOS

for (@buffer) {
    if (m/(\d+\..*?)\.?\s*\((Detached|Attached)\)/) {
        push (@sessions, $1);
        print "     $i.  $1\n";
        ++$i;
    }
}

print "  ------------------------\n";

my $input;
if (scalar @ARGV) {
    chomp($input = $ARGV[0]);
} else {
    print "\n  Reattach to session: ";
    chomp($input = <>);
}

my $session;
if ($input =~ m/^\d+$/ && $input > 0 && $input < $i) {
    $session = $sessions[$input-1];
} else {
    for (@sessions) {
        $session = $1 if (m/(.*\.$input$)/);
    }
}

if ($session) {
    $session =~ s/\s+.*//; # remove cruft at end of screen -ls output
    `screen -d -r $session`;
} else {
    print "  Could not reattach to '$input'\n";
}
