#!/usr/bin/env ruby

require 'yaml'
require 'pp'

unless ARGV.count == 1
	STDERR.puts "USAGE: $0: /relative/url"
	exit 1
end

config_file = ENV['BOSH_CONFIG'] || "#{ENV['HOME']}/.bosh_config"
unless File.exists? config_file
	STDERR.puts "#{config_file}: not found"
	exit 2
end

config = YAML.load(File.open(config_file))
unless config.has_key? 'target'
	STDERR.puts "#{config_file}: target not found in configuration"
	exit 3
end
target = config['target']

cmd = [ "/usr/bin/env", "curl", "-Lsk" ];
if config.has_key? "auth" and config['auth'].has_key? target
	auth = config['auth'][target]
	cmd = cmd.concat(['--basic', '--user', "#{auth['username']}:#{auth['password']}"])
end
if STDOUT.tty?
	STDERR.puts ">>" + cmd.join(" ")
end
exec(*(cmd.concat(["#{target}/#{ARGV[0]}"])))
